# Кастомный Telegram-агент для реферального маркетинга (Рабочая Версия)

Этот проект реализует автономный ИИ-агент для проактивного реферального маркетинга в Telegram, полностью заменяя имитации на рабочий код и внедряя отказоустойчивую архитектуру с GigaChat.

## Технологический Стек

*   **Ядро Агента:** LangChain (RAG-цепочка) с **отказоустойчивым механизмом (Fallback)**.
*   **LLM (Primary):** GigaChat (через GigaChain) — основной провайдер.
*   **LLM (Secondary):** Hugging Face Inference API (бесплатный уровень) — резервный провайдер.
*   **Fallback:** Шаблонная генерация (гарантированно бесплатно).
*   **Отказоустойчивость:** Реализована стратегия **"Безопасное завершение"** при сбое GigaChat, чтобы избежать непредвиденных расходов.
*   **База Знаний:** ChromaDB (векторная база данных).
*   **Интерфейс Telegram:** Pyrogram (для проактивного общения через Telegram User API).

## Файлы Проекта

| Файл | Описание |
| :--- | :--- |
| `products.json` | Имитация базы данных реферальных продуктов. |
| `init_db.py` | Скрипт для инициализации векторной базы данных (`./chroma_db`). **Запускается один раз.** |
| `agent_core.py` | **Обновлено:** Основная логика LangChain-агента с поддержкой GigaChat и механизмом резервирования. |
| `proactive_agent.py` | **Обновлено:** Рабочий скрипт, использующий Pyrogram для извлечения истории чата и отправки сообщений. |
| `README.md` | Этот файл. |
| `gigachat_architecture_proposal.md` | Архитектурное обоснование интеграции GigaChat и отказоустойчивости. |

## Пошаговый Запуск (Под ключ)

### Шаг 1: Установка Зависимостей

Установите все необходимые пакеты, включая GigaChain:

```bash
pip install langchain chromadb pydantic sentence-transformers pyrogram langchain-community jq langchain-text-splitters gigachain
```

### Шаг 2: Настройка Переменных Окружения

Для работы агента требуются три ключевые переменные окружения. Вы можете создать файл `.env` или экспортировать их в консоли.

| Переменная | Назначение | Как получить |
| :--- | :--- | :--- |
| `TG_API_ID` | Идентификатор Telegram API | Получите на [my.telegram.org](https://my.telegram.org) |
| `TG_API_HASH` | Хеш Telegram API | Получите на [my.telegram.org](https://my.telegram.org) |

| `GIGACHAT_CREDENTIALS` | Токен авторизации GigaChat | Получите в личном кабинете разработчика Сбер |
| `HF_TOKEN` | Токен Hugging Face | Получите на [huggingface.co/settings/tokens](https://huggingface.co/settings/tokens) (требуется для резервного LLM) |

**Пример экспорта в консоли:**

```bash
export TG_API_ID="ВАШ_API_ID"
export TG_API_HASH="ВАШ_API_HASH"

export GIGACHAT_CREDENTIALS="ВАШ_GIGACHAT_ТОКЕН"
export HF_TOKEN="ВАШ_HUGGING_FACE_ТОКЕН"
```

### Шаг 3: Инициализация Базы Знаний

```bash
python3 init_db.py
```

### Шаг 4: Первый Запуск и Авторизация Pyrogram

При первом запуске `proactive_agent.py` Pyrogram запросит ваш номер телефона, код подтверждения и, возможно, пароль двухфакторной аутентификации. Это необходимо для создания файла сессии (`my_account.session`), который позволит агенту действовать от вашего имени.

```bash
python3 proactive_agent.py
```

**ВНИМАНИЕ:** После успешной авторизации агент начнет **автоматически** извлекать историю чатов и **генерировать** сообщения для **всех найденных целевых пользователей**. **Для активации отправки сообщений** вам необходимо **раскомментировать** строку `await app.send_message(...)` в файле `proactive_agent.py`. **Будьте осторожны!** Telegram имеет строгие лимиты на массовую рассылку. Рекомендуется сначала протестировать на небольшом количестве контактов.

## Отказоустойчивость (Оркестрация)

Агент настроен на использование **GigaChat** как основного LLM.

1.  **GigaChat (Primary):** Если он недоступен, система переключается на...
2.  **Hugging Face (Secondary):** Если и он недоступен (например, превышены бесплатные лимиты), система переключается на...
3.  **Шаблонная Генерация (Fallback):** Гарантированно бесплатная внутренняя логика, которая использует извлеченный контекст для создания простого сообщения.

Эта трехуровневая архитектура обеспечивает максимальную отказоустойчивость при сохранении строго бесплатного подхода.

---
**Следующий шаг:** Вы можете начать тестирование агента. Если вы хотите, чтобы я помог с развертыванием на бесплатном облачном сервисе (например, Google Cloud Run), сообщите мне.
